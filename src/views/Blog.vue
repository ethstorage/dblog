<template>
  <div>
    <w3q-tip bgColor="#2F6FFF" fontColor="#ffffff"/>

    <b-navbar-item tag="div" class="connect-wallet">
      <a
          class="button is-primary"
          :active="true"
          @click="onConnectWallet"
      >
        {{ this.connectWalletMessage }}
      </a>
    </b-navbar-item>

    <div
        v-if="mode === 'init'"
        class="container block"
        style="margin-top: 1vw; max-width: 685px"
    >
      <section class="hero is-medium">
        <div class="hero-body">
          <div class="">
            <p class="title">Web3Q Blog Platform</p>
            <p class="subtitle">Experience decentralized blogging</p>
          </div>
        </div>
      </section>
      <b-field label="Input your blog contract address">
        <b-input
            v-model="inputBlogAddress"
            placeholder="0x1234.... or myname.w3q"
            class="code"
            expanded
        ></b-input>
        <p class="control" @click="enterBlog">
          <b-button type="is-primary" label="Enter"/>
        </p>
      </b-field>
      <b-field
          label="Or deploy a new one"
          type="is-success"
          :message="deployBlogMessage"
      >
        <p class="control">
          <button
              class="button is-primary is-outlined is-fullwidth"
              :disabled="!isChainSupported"
              @click="onDeployBlog"
          >
            Deploy
          </button>
        </p>
      </b-field>

      <b-field
          label="... and then link your blog to your W3NS domain"
          type="is-success"
      >
        <b-input
            v-model="domain"
            placeholder="Domain"
            style="max-width: 125px"
        ></b-input>
        <p class="control">
          <span class="button is-static">.w3q</span>
        </p>
        <b-input
            v-model="inputBlogAddressToLink"
            placeholder="Blog contract address: 0x1234..."
            class="code"
            expanded
        ></b-input>
        <p class="control">
          <b-button
              type="is-primary"
              label="Link"
              :disabled="!isChainSupported"
              @click="onLink"
          />
        </p>
      </b-field>
    </div>

    <div v-else-if="mode === 'list'">
      <section class="hero">
        <div class="hero-body">
          <p class="title">Web3Q Blog Example</p>
          <p class="subtitle">
            <router-link to="/">back to the portal</router-link>
          </p>
        </div>
      </section>

      <div class="container blog" style="max-width: 700px">
        <div class="container block" v-if="this.$asyncComputed.blogs.updating">
          <h6>&lt;loading&gt;</h6>
        </div>
        <div class="container block" v-else-if="blogs.message">
          <h6>{{ blogs.message }}</h6>
        </div>
        <div class="container block" v-else-if="blogs.length === 0">
          <h6>&lt;nothing yet&gt;</h6>
        </div>
        <div class="container block" v-for="blog in blogs" :key="blog.title">
          <label class="subtitle blog-time">{{
              _renderTimestamp(blog.timestamp)
            }}</label>
          <h3>
            <router-link :to="`/blog/${$route.params.address}/${blog.idx}`">{{
                blog.title
              }}
            </router-link>
          </h3>
        </div>

        <div v-if="isOwner" class="buttons">
          <b-button type="is-primary" outlined expanded @click="openCreateModal"
          >Add a new post
          </b-button
          >
        </div>
      </div>
    </div>

    <div v-else-if="mode === 'content'">
      <section class="hero">
        <div class="hero-body">
          <p class="title">{{ currentBlog.title }}</p>
          <p class="subtitle">
            {{ _renderTimestamp(currentBlog.timestamp) }}
            <router-link :to="`/blog/${$route.params.address}`">&nbsp;&nbsp;see all posts</router-link>
          </p>
        </div>
      </section>
      <div class="container content blog blog-content" style="max-width: 700px">
        <div v-html="parseMarkdown(currentBlog.content)" style="padding: 30px 15px 50px; margin-bottom: 10px"></div>

        <div
            v-if="isOwner"
            class="buttons"
            style="display: flex; justify-content: flex-end"
        >
          <b-button
              label="Edit"
              type="is-primary"
              icon-left="pen"
              @click="openEditModal"
          />
          <b-button
              label="Delete"
              type="is-dark"
              icon-left="delete"
              @click="deleteBlog"
          />
        </div>

        <div style="margin: 35px 0; border: 1px solid #CCCCCC50; padding: 15px">
          <h5>Comments</h5>
          <textarea
              v-model="commentText"
              placeholder="Comment content"
              rows="5"
              style="width: 100%">
          </textarea>
          <div style="display: flex; justify-content: flex-end; margin: 10px 0 0">
            <b-button label="Write" type="is-primary" @click="onComment"/>
          </div>
        </div>

        <div v-for="(item, index) in comments" :key="item.timestamp"
             style="border: 1px solid #0087FF50; padding: 15px; margin-bottom: 10px">
          <div style="display: flex; flex-direction: row; justify-content: space-between">
            <div style="font-size: 14px">ID: {{ index }}</div>
            <div style="font-size: 12px">Author: {{ item.user }}</div>
          </div>
          <div style="width: 100%; height: 1px; background: #1B60FF25; margin: 15px 0"></div>
          <div>{{ item.content }}</div>
          <div style="display: flex; flex-direction: row-reverse; margin: 20px 0 0px">
            <div style="font-size: 12px; color: #CCCCCC">Time: {{ _renderTimestamp(new Date(item.timestamp)) }}</div>
          </div>
        </div>

        <div
            class="buttons"
            style="display: flex; justify-content: center; align-items: center"
        >
          <router-link
              v-if="$asyncComputed.prevPost.success && prevPost"
              :to="prevPost"
          >
            <b-icon icon="arrow-left" size="is-large" type="is-dark"></b-icon>
          </router-link>
          <router-link
              v-if="$asyncComputed.nextPost.success && nextPost"
              :to="nextPost"
          >
            <b-icon icon="arrow-right" size="is-large" type="is-dark"></b-icon>
          </router-link>
        </div>
      </div>
    </div>

    <Footer color="#000000" class="footer-layout"/>

    <b-modal
        :active="isEditingBlog"
        has-modal-card
        full-screen
        trap-focus
        :destroy-on-hide="false"
        aria-role="dialog"
        aria-label="Blog Editing"
        close-button-aria-label="Close"
        v-on:after-enter="initSimpleMDE"
        aria-modal
    >
      <div class="modal-card" style="min-width: 640px">
        <section class="modal-card-body">
          <b-field label="Title">
            <b-input v-model="editingTitle" required></b-input>
          </b-field>
          <div class="markdown-editor-wrapper">
            <textarea id="markdown-editor"></textarea>
          </div>
        </section>

        <div v-if="this.fileUrl" style="padding: 15px; text-align: left">
          Upload status: {{ this.fileUrl }}
        </div>

        <footer class="modal-card-foot">
          <b-button label="Close" @click="isEditingBlog = false"/>
          <b-button label="Done" type="is-primary" @click="write"/>
          <b-upload v-model="file" class="file-label">
            <span class="file-cta">
              <b-icon class="file-icon" icon="upload"></b-icon>
              <span class="file-label">Upload Image</span>
            </span>
          </b-upload>
        </footer>
      </div>
    </b-modal>

    <b-loading
        v-model="isLoading"
        :is-full-page="false"
        :can-cancel="true"
        style="z-index: 999"
    />
  </div>
</template>
<script>

import {ethers} from "ethers";
import Footer from "@/views/Footer";
import namehash from "eth-ens-namehash";

const sha3 = require('js-sha3').keccak_256;

const stringToHex = (s) => ethers.utils.hexlify(ethers.utils.toUtf8Bytes(s));
const hexToString = (h) => ethers.utils.toUtf8String(h);

// contract utils
const getContract = (address, abi) => {
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  const contract = new ethers.Contract(address, abi, provider);
  return contract.connect(provider.getSigner());
}

function httpRequest(url, method, data) {
  const init = {method};
  switch (method) {
    case "GET":
      if (data) url = `${url}?${new URLSearchParams(data)}`;
      break;
    case "POST":
    case "PUT":
    case "PATCH":
      init.body = JSON.stringify(data);
  }
  return fetch(url, init);
}

// from https://gist.github.com/v1vendi/75d5e5dad7a2d1ef3fcb48234e4528cb
function generateAPI(url) {
  // a hack, so we can use field either as property or a method
  const callable = () => {
  };
  callable.url = url;

  return new Proxy(callable, {
    get({url}, propKey) {
      return ["GET", "POST", "PUT", "DELETE", "PATCH"].includes(
          propKey.toUpperCase()
      )
          ? (data) => httpRequest(url, propKey.toUpperCase(), data)
          : generateAPI(`${url}/${propKey}`);
    },
    apply({url}, _, [arg] = []) {
      return generateAPI(arg ? `${url}/${arg}` : url);
    },
  });
}

// contract utils

const blogContractInfo = {
  abi: [
    "function writeBlog(bytes memory title, bytes memory content) public payable",
    "function editBlog(uint256 idx, bytes memory newTitle, bytes memory newContent) public payable",
    "function deleteBlog(uint256 idx) public",
    "function writeComment(uint256 blogIdx, bytes memory content) public payable",
    "function deleteComment(uint256 blogIdx, uint256 commentId) public",
  ],
};

// file update
const FileContractInfo = {
  abi: [
    "function write(bytes memory filename, bytes memory data) public payable",
    "function writeChunk(bytes memory name, uint256 chunkId, bytes memory data) public payable",
    "function files(bytes memory filename) public view returns (bytes memory)",
    "function remove(bytes memory name) external returns (uint256)",
    "function countChunks(bytes memory name) external view returns (uint256)",
    "function getChunkHash(bytes memory name, uint256 chunkId) public view returns (bytes32)"
  ],
};

const nameServiceContractInfo = {
  address: "0x076B3e04dd300De7db95Ba3F5db1eD31f3139aE0",
  abi: [
    "function setText(bytes32 node, string calldata key, string calldata value) external",
  ],
};

// blog
const blogContract = (address) => {
  return getContract(address, blogContractInfo.abi);
};
const blogAPI = (subURL) => generateAPI(`https://galileo.web3q.io/${subURL}`);


const nameServiceContract = () => {
  const {address, abi} = nameServiceContractInfo;
  return getContract(address, abi);
};

const nameServiceAPI = (subURL) => generateAPI(
    `https://galileo.web3q.io/${nameServiceContractInfo.address}:3334${subURL}`
);

const FileContract = (address) => {
  return getContract(address, FileContractInfo.abi);
};

export class UnsupportedChainIdError extends Error {
  constructor() {
    super('UnsupportedChainIdError: not support chain')
  }
}

const chain = 3334;
const chainID = `0x${chain.toString(16)}`;
const nodes = ['https://galileo.web3q.io:8545']
const explorers = [`https://explorer.galileo.web3q.io/`];

export default {
  name: "Blog",
  components: {
    Footer,
  },
  data() {
    return {
      currentAccount: null,
      isLoading: false,
      isEditingBlog: false,
      editingTitle: "",
      markdownEditor: null,
      inputBlogAddress: "",
      domain: "",
      deployedBlog: "",
      inputBlogAddressToLink: "",

      commentText: "",

      file: null,
      fileUrl: "",
    };
  },
  async created() {
    this.onConnectWallet();
    window.ethereum.on("accountsChanged", this.handleAccountsChanged);
    window.ethereum.on("chainChanged", () => window.location.reload());
  },
  methods: {
    onConnectWallet() {
      if (this.currentAccount) {
        return;
      }
      if (!window.ethereum) {
        alert("please install metamask");
        return;
      }
      this.login();
    },
    async login() {
      window.ethereum
          .request({method: "eth_requestAccounts"})
          .then(this.handleAccountsChanged)
          .catch(async (error) => {
            if (error.code === 4001) {
              this.$message.error('User rejected');
            } else if (error instanceof UnsupportedChainIdError) {
              const hasSetup = await this.setupNetwork();
              if (hasSetup) {
                await this.login();
              }
            } else {
              this.$message.error('Connect Error');
            }
          });
    },
    async setupNetwork() {
      const provider = window.ethereum;
      if (provider) {
        try {
          await provider.request({
            method: 'wallet_addEthereumChain',
            params: [
              {
                chainId: chainID,
                chainName: 'Web3Q Galileo',
                nativeCurrency: {
                  name: 'W3Q',
                  symbol: 'W3Q',
                  decimals: 18,
                },
                rpcUrls: nodes,
                blockExplorerUrls: explorers,
              },
            ],
          })
          const newChainId = await window.ethereum.request({method: "eth_chainId"});
          if (chainID !== newChainId) {
            this.$message.error('User rejected');
            return false;
          }
          return true;
        } catch (error) {
          this.$message.error('Failed to setup the network in Metamask');
          return false
        }
      } else {
        this.$message.error('Can\'t setup the Web3Q network on metamask because window.ethereum is undefined');
        return false
      }
    },
    async handleAccountsChanged(accounts) {
      // account
      if (accounts.length === 0) {
        this.currentAccount = null;
        console.warn(
            "MetaMask is locked or the user has not connected any accounts"
        );
        return;
      }
      const newChainId = await window.ethereum.request({method: "eth_chainId"});
      if (chainID !== newChainId) {
        this.currentAccount = null;
        throw new UnsupportedChainIdError();
      }

      if (accounts[0] !== this.currentAccount) {
        this.currentAccount = accounts[0];
      }
    },
    async onDeployBlog() {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const receipt = await this._doTx(() =>
          // Deploy `SimpleBlog`
          provider.getSigner().sendTransaction({
            data: "0x60c0604052600060a09081526002906200001a9082620001b3565b503480156200002857600080fd5b5060006080819052600380546001600160a01b031916331790556040518190620000529062000100565b60ff9091168152602001604051809103906000f08015801562000079573d6000803e3d6000fd5b5060405163a6f9dae160e01b81523360048201529091506001600160a01b0382169063a6f9dae190602401600060405180830381600087803b158015620000bf57600080fd5b505af1158015620000d4573d6000803e3d6000fd5b5050600780546001600160a01b0319166001600160a01b039490941693909317909255506200027f9050565b611fe1806200476883390190565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200013957607f821691505b6020821081036200015a57634e487b7160e01b600052602260045260246000fd5b50919050565b601f821115620001ae57600081815260208120601f850160051c81016020861015620001895750805b601f850160051c820191505b81811015620001aa5782815560010162000195565b5050505b505050565b81516001600160401b03811115620001cf57620001cf6200010e565b620001e781620001e0845462000124565b8462000160565b602080601f8311600181146200021f5760008415620002065750858301515b600019600386901b1c1916600185901b178555620001aa565b600085815260208120601f198616915b8281101562000250578886015182559484019460019091019084016200022f565b50858210156200026f5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b6080516144cd6200029b600039600061192b01526144cd6000f3fe608060405260043610620001a65760003560e01c80638da5cb5b11620000e5578063ba742b721162000097578063d4868baa116200006d578063d4868baa1462000631578063dc3c82281462000667578063dd473fae146200067e578063df41c3cf146200069a57620001a6565b8063ba742b7214620005c7578063bd666ab514620005de578063ce55f67314620005f557620001a6565b80638da5cb5b14620004e8578063a3dff135146200050a578063a5e0880d1462000533578063a6f9dae11462000558578063ae52575c146200057d578063af21c8b214620005a257620001a6565b80633ec67494116200015d57806363af2626116200013357806363af2626146200041657806371a97305146200043d57806380f052d8146200047857806386e107a214620004ad57620001a6565b80633ec67494146200036457806358edef4c14620003c8578063590e1ae314620003fe57620001a6565b8063038cd79f146200028357806309362861146200029c5780631c993ad514620002cc57806323edf69714620002f15780632b68b9c6146200032757806331a4bcb5146200033f575b348015620001b357600080fd5b5060006200025360028054620001c99062001ece565b80601f0160208091040260200160405190810160405280929190818152602001828054620001f79062001ece565b8015620002485780601f106200021c5761010080835404028352916020019162000248565b820191906000526020600020905b8154815290600101906020018083116200022a57829003601f168201915b5050505050620006cb565b90506000816040516020016200026a919062001f5e565b6040516020818303038152906040529050805160208201f35b6200029a6200029436600462002042565b620006f3565b005b348015620002a957600080fd5b50620002b46200074b565b604051620002c3919062001f5e565b60405180910390f35b348015620002d957600080fd5b506200029a620002eb366004620020ac565b620007e1565b348015620002fe57600080fd5b506200031662000310366004620020ec565b62000820565b604051620002c39392919062002162565b3480156200033457600080fd5b506200029a62000b8b565b3480156200034c57600080fd5b506200029a6200035e366004620021dd565b62000bc6565b3480156200037157600080fd5b50620003a862000383366004620020ec565b600660205260009081526040902080546001909101546001600160a01b039091169082565b604080516001600160a01b039093168352602083019190915201620002c3565b348015620003d557600080fd5b50620003ed620003e7366004620020ac565b62000d74565b6040519015158152602001620002c3565b3480156200040b57600080fd5b506200029a62000dc6565b3480156200042357600080fd5b506200042e60055481565b604051908152602001620002c3565b3480156200044a57600080fd5b506007546200045f906001600160a01b031681565b6040516001600160a01b039091168152602001620002c3565b3480156200048557600080fd5b506200049d62000497366004620020ec565b62000e30565b604051620002c392919062002200565b348015620004ba57600080fd5b50620004d2620004cc366004620020ec565b62000ef5565b60408051928352901515602083015201620002c3565b348015620004f557600080fd5b506003546200045f906001600160a01b031681565b3480156200051757600080fd5b506200052262000f57565b604051620002c39392919062002261565b3480156200054057600080fd5b50620004d262000552366004620020ec565b620011d1565b3480156200056557600080fd5b506200029a62000577366004620022b6565b6200123a565b3480156200058a57600080fd5b50620002b46200059c366004620020ac565b620006cb565b348015620005af57600080fd5b506200029a620005c1366004620020ec565b620012e8565b6200029a620005d836600462002042565b620013c3565b6200029a620005ef366004620022d6565b620014d2565b3480156200060257600080fd5b506200042e62000614366004620021dd565b600160209081526000928352604080842090915290825290205481565b3480156200063e57600080fd5b506200065662000650366004620020ec565b62001684565b604051620002c39392919062002316565b6200029a6200067836600462002345565b620017a2565b3480156200068b57600080fd5b50636175746f60e01b6200042e565b348015620006a757600080fd5b506200042e620006b9366004620020ec565b60006020819052908152604090205481565b60606000620006db836020015190565b90506000620006ea8262001840565b50949350505050565b6003546001600160a01b03163314620007295760405162461bcd60e51b81526004016200072090620023b8565b60405180910390fd5b600062000737836020015190565b905062000746818334620018a1565b505050565b600280546200075a9062001ece565b80601f0160208091040260200160405190810160405280929190818152602001828054620007889062001ece565b8015620007d95780601f10620007ad57610100808354040283529160200191620007d9565b820191906000526020600020905b815481529060010190602001808311620007bb57829003601f168201915b505050505081565b6003546001600160a01b031633146200080e5760405162461bcd60e51b81526004016200072090620023b8565b60026200081c828262002433565b5050565b6000818152600660205260409020805460609182918291906001600160a01b031680620008b957604080516000808252602082018181528284019093529091906200087c565b6060815260200190600190039081620008665790505b506040805160008082526020820190925290620008aa565b6060815260200190600190039081620008945790505b50945094509450505062000b84565b6001820154806001600160401b03811115620008d957620008d962001f73565b60405190808252806020026020018201604052801562000903578160200160208202803683370190505b509550806001600160401b0381111562000921576200092162001f73565b6040519080825280602002602001820160405280156200095657816020015b6060815260200190600190039081620009405790505b509450806001600160401b0381111562000974576200097462001f73565b604051908082528060200260200182016040528015620009a957816020015b6060815260200190600190039081620009935790505b5093508160005b8281101562000b7e57604051632d8cd88360e21b8152600481018290526001600160a01b0383169063b633620c90602401600060405180830381865afa158015620009ff573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f1916820160405262000a299190810190620024ff565b87828151811062000a3e5762000a3e6200257e565b602090810291909101015260405163620d1b0560e11b8152600481018290526001600160a01b0383169063c41a360a90602401602060405180830381865afa15801562000a8f573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000ab5919062002594565b88828151811062000aca5762000aca6200257e565b6001600160a01b039283166020918202929092010152604051620800e360e81b81526004810183905290831690630800e30090602401600060405180830381865afa15801562000b1e573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f1916820160405262000b489190810190620024ff565b86828151811062000b5d5762000b5d6200257e565b6020026020010181905250808062000b7590620025ca565b915050620009b0565b50505050505b9193909250565b6003546001600160a01b0316331462000bb85760405162461bcd60e51b81526004016200072090620023b8565b6003546001600160a01b0316ff5b600082815260066020526040902080546001600160a01b03168062000c1f5760405162461bcd60e51b815260206004820152600e60248201526d189b1bd9c81b9bdd08195e1a5cdd60921b604482015260640162000720565b60405163620d1b0560e11b81526004810184905281906000906001600160a01b0383169063c41a360a90602401602060405180830381865afa15801562000c6a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019062000c90919062002594565b90506001600160a01b038116331462000ce45760405162461bcd60e51b81526020600482015260156024820152744f6e6c79206f776e65722063616e2064656c65746560581b604482015260640162000720565b60018401546040516331a4bcb560e01b81526001600160a01b038416916331a4bcb59162000d1f918991600401918252602082015260400190565b600060405180830381600087803b15801562000d3a57600080fd5b505af115801562000d4f573d6000803e3d6000fd5b5050506001850180549150600062000d6783620025e6565b9190505550505050505050565b6003546000906001600160a01b0316331462000da45760405162461bcd60e51b81526004016200072090620023b8565b600062000db2836020015190565b905062000dbf81620019b6565b9392505050565b6003546001600160a01b0316331462000df35760405162461bcd60e51b81526004016200072090620023b8565b6003546040516001600160a01b03909116904780156108fc02916000818181858888f1935050505015801562000e2d573d6000803e3d6000fd5b50565b6004818154811062000e4157600080fd5b906000526020600020906002020160009150905080600001805462000e669062001ece565b80601f016020809104026020016040519081016040528092919081815260200182805462000e949062001ece565b801562000ee55780601f1062000eb95761010080835404028352916020019162000ee5565b820191906000526020600020905b81548152906001019060200180831162000ec757829003601f168201915b5050505050908060010154905082565b6000805b821562000f4c57600462000f0d84620025e6565b9350838154811062000f235762000f236200257e565b90600052602060002090600202016001015460001462000f465750909160019150565b62000ef9565b506000928392509050565b60608060606005546001600160401b0381111562000f795762000f7962001f73565b60405190808252806020026020018201604052801562000fae57816020015b606081526020019060019003908162000f985790505b5092506005546001600160401b0381111562000fce5762000fce62001f73565b60405190808252806020026020018201604052801562000ff8578160200160208202803683370190505b5091506005546001600160401b0381111562001018576200101862001f73565b60405190808252806020026020018201604052801562001042578160200160208202803683370190505b5090506000805b600454811015620011ca576000600482815481106200106c576200106c6200257e565b9060005260206000209060020201604051806040016040529081600082018054620010979062001ece565b80601f0160208091040260200160405190810160405280929190818152602001828054620010c59062001ece565b8015620011165780601f10620010ea5761010080835404028352916020019162001116565b820191906000526020600020905b815481529060010190602001808311620010f857829003601f168201915b5050505050815260200160018201548152505090508060200151600014620011b45780600001518684815181106200115257620011526200257e565b602002602001018190525080602001518584815181106200117757620011776200257e565b602002602001018181525050818484815181106200119957620011996200257e565b602090810291909101015282620011b081620025ca565b9350505b5080620011c181620025ca565b91505062001049565b5050909192565b6000805b600454620011e69060019062002600565b83101562000f4c576004620011fb84620025ca565b935083815481106200121157620012116200257e565b906000526020600020906002020160010154600014620012345750909160019150565b620011d5565b6003546001600160a01b031633146200128c5760405162461bcd60e51b815260206004820152601360248201527221b0b63632b91034b9903737ba1037bbb732b960691b604482015260640162000720565b6003546040516001600160a01b038084169216907f342827c97908e5e2f71151c08502a66d44b6f758e3ac2f1de95f02eb95f0a73590600090a3600380546001600160a01b0319166001600160a01b0392909216919091179055565b60048181548110620012fe57620012fe6200257e565b906000526020600020906002020160010154600003620013535760405162461bcd60e51b815260206004820152600f60248201526e189b1bd9c81a5cc819195b195d1959608a1b604482015260640162000720565b6000600482815481106200136b576200136b6200257e565b6000918252602082206001600290920201019190915560058054916200139183620025e6565b91905055506200081c81604051602001620013ae91815260200190565b60405160208183030381529060405262000d74565b60048054604080518082019091528481524260208201526001820183556000929092528151909190600283027f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b0190819062001420908262002433565b5060209190910151600190910155600580549060006200144083620025ca565b919050555062001473816040516020016200145d91815260200190565b60405160208183030381529060405283620006f3565b6000818152600660205260408082209051909190620014929062001eb2565b604051809103906000f080158015620014af573d6000803e3d6000fd5b5082546001600160a01b0319166001600160a01b03919091161790915550505050565b600082815260066020526040902080546001600160a01b0316806200152b5760405162461bcd60e51b815260206004820152600e60248201526d189b1bd9c81b9bdd08195e1a5cdd60921b604482015260640162000720565b600182015460405163bd666ab560e01b815282916001600160a01b0383169163bd666ab5916200156091889060040162002616565b600060405180830381600087803b1580156200157b57600080fd5b505af115801562001590573d6000803e3d6000fd5b505050506001830154604051631aa7bca560e21b815260048101919091523360248201526001600160a01b03821690636a9ef29490604401600060405180830381600087803b158015620015e357600080fd5b505af1158015620015f8573d6000803e3d6000fd5b505050506001830154604051632e489fcb60e01b815260048101919091524260248201526001600160a01b03821690632e489fcb90604401600060405180830381600087803b1580156200164b57600080fd5b505af115801562001660573d6000803e3d6000fd5b505050600184018054915060006200167883620025ca565b91905055505050505050565b606060006060600060048581548110620016a257620016a26200257e565b9060005260206000209060020201604051806040016040529081600082018054620016cd9062001ece565b80601f0160208091040260200160405190810160405280929190818152602001828054620016fb9062001ece565b80156200174c5780601f1062001720576101008083540402835291602001916200174c565b820191906000526020600020905b8154815290600101906020018083116200172e57829003601f168201915b5050505050815260200160018201548152505090506200178e856040516020016200177991815260200190565b604051602081830303815290604052620006cb565b815160209092015191969195509350915050565b600060048481548110620017ba57620017ba6200257e565b9060005260206000209060020201905080600101546000036200180f5760405162461bcd60e51b815260206004820152600c60248201526b1b9bdb8b595e1a5cdd195b9d60a21b604482015260640162000720565b806200181c848262002433565b5042600182015560408051602081018690526200183a91016200145d565b50505050565b600081815260208190526040812054606091906200185e8162001a63565b156200188a5760008481526001602052604081206200187e908362001a78565b95600195509350505050565b80620018968162001b1f565b935093505050915091565b600083815260208190526040902054620018bb8162001a63565b6200192957806001600160a01b038116156200192757806001600160a01b0316632b68b9c66040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156200190d57600080fd5b505af115801562001922573d6000803e3d6000fd5b505050505b505b7f000000000000000000000000000000000000000000000000000000000000000060ff168351111562001987576200197262001966848462001bd8565b6001600160a01b031690565b6000858152602081905260409020556200183a565b6000848152600160205260409020620019a1908462001cb9565b60008581526020819052604090205550505050565b60008181526020819052604081205480620019d45750600092915050565b620019df8162001a63565b62001a4d57806001600160a01b0381161562001a4b57806001600160a01b0316632b68b9c66040518163ffffffff1660e01b8152600401600060405180830381600087803b15801562001a3157600080fd5b505af115801562001a46573d6000803e3d6000fd5b505050505b505b5050600090815260208190526040812055600190565b60008062001a718360e01c90565b1192915050565b6060600062001a878362001d53565b92509050601c81111562001b1857603c82016000805b6020600162001aae601c8762002600565b62001abb90602062002631565b62001ac7919062002600565b62001ad3919062002647565b81101562001b145760008181526020888152604090912054808552925062001afd90849062002631565b92508062001b0b81620025ca565b91505062001a9d565b5050505b5092915050565b6060600080600062001b318562001dbe565b915091508062001b565750506040805160008082526020820190925294909350915050565b6000826001600160401b0381111562001b735762001b7362001f73565b6040519080825280601f01601f19166020018201604052801562001b9e576020820181803683370190505b50905060006040518061016001604052806101268152602001620043726101269139519050838160208401893c5095600195509350505050565b6000806040518061016001604052806101268152602001620043726101269139805185519192509060009062001c0f908362002631565b808452601f19603f8201168401604052905062001c4260208701836020860162001c3a919062002631565b885162001e24565b600062001c526043602062002631565b3085820152905062001c67608c602062002631565b90503081850152506000858460405162001c819062001ec0565b62001c8d919062001f5e565b6040518091039082f090508015801562001cab573d6000803e3d6000fd5b509450505050505b92915050565b805160208083015160e083901b911c1790601c81111562001b18576000603c8401815b6020600162001ced601c8762002600565b62001cfa90602062002631565b62001d06919062002600565b62001d12919062002647565b81101562001b14578151925062001d2b82602062002631565b600082815260208990526040902084905591508062001d4a81620025ca565b91505062001cdc565b6000606062001d628360e01c90565b9150602083901b9250816001600160401b0381111562001d865762001d8662001f73565b6040519080825280601f01601f19166020018201604052801562001db1576020820181803683370190505b5060208101939093525091565b6000806001600160a01b03831662001ddb57506000928392509050565b6000806040518061016001604052806101268152602001620043726101269139519050843b91508082101562001e18575060009485945092505050565b6200187e818362002600565b62001e30818462002631565b925062001e3e818362002631565b91505b6020811062001e815762001e5760208362002600565b915062001e6660208462002600565b80518352925062001e7960208262002600565b905062001e41565b8060000362001e8f57505050565b62001e9b818462002600565b925062001ea9818362002600565b92519092525050565b611bfc806200266b83390190565b61010b806200426783390190565b600181811c9082168062001ee357607f821691505b60208210810362001f0457634e487b7160e01b600052602260045260246000fd5b50919050565b60005b8381101562001f2757818101518382015260200162001f0d565b50506000910152565b6000815180845262001f4a81602086016020860162001f0a565b601f01601f19169290920160200192915050565b60208152600062000dbf602083018462001f30565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f191681016001600160401b038111828210171562001fb45762001fb462001f73565b604052919050565b60006001600160401b0382111562001fd85762001fd862001f73565b50601f01601f191660200190565b600082601f83011262001ff857600080fd5b81356200200f620020098262001fbc565b62001f89565b8181528460208386010111156200202557600080fd5b816020850160208301376000918101602001919091529392505050565b600080604083850312156200205657600080fd5b82356001600160401b03808211156200206e57600080fd5b6200207c8683870162001fe6565b935060208501359150808211156200209357600080fd5b50620020a28582860162001fe6565b9150509250929050565b600060208284031215620020bf57600080fd5b81356001600160401b03811115620020d657600080fd5b620020e48482850162001fe6565b949350505050565b600060208284031215620020ff57600080fd5b5035919050565b600082825180855260208086019550808260051b84010181860160005b848110156200215557601f198684030189526200214283835162001f30565b9884019892509083019060010162002123565b5090979650505050505050565b606080825284519082018190526000906020906080840190828801845b82811015620021a65781516001600160a01b0316845292840192908401906001016200217f565b50505083810382850152620021bc818762002106565b9150508281036040840152620021d3818562002106565b9695505050505050565b60008060408385031215620021f157600080fd5b50508035926020909101359150565b60408152600062002215604083018562001f30565b90508260208301529392505050565b600081518084526020808501945080840160005b83811015620022565781518752958201959082019060010162002238565b509495945050505050565b60608152600062002276606083018662002106565b82810360208401526200228a818662002224565b90508281036040840152620021d3818562002224565b6001600160a01b038116811462000e2d57600080fd5b600060208284031215620022c957600080fd5b813562000dbf81620022a0565b60008060408385031215620022ea57600080fd5b8235915060208301356001600160401b038111156200230857600080fd5b620020a28582860162001fe6565b6060815260006200232b606083018662001f30565b8460208401528281036040840152620021d3818562001f30565b6000806000606084860312156200235b57600080fd5b8335925060208401356001600160401b03808211156200237a57600080fd5b620023888783880162001fe6565b935060408601359150808211156200239f57600080fd5b50620023ae8682870162001fe6565b9150509250925092565b6020808252600f908201526e36bab9ba10333937b69037bbb732b960891b604082015260600190565b601f8211156200074657600081815260208120601f850160051c810160208610156200240a5750805b601f850160051c820191505b818110156200242b5782815560010162002416565b505050505050565b81516001600160401b038111156200244f576200244f62001f73565b620024678162002460845462001ece565b84620023e1565b602080601f8311600181146200249f5760008415620024865750858301515b600019600386901b1c1916600185901b1785556200242b565b600085815260208120601f198616915b82811015620024d057888601518255948401946001909101908401620024af565b5085821015620024ef5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b6000602082840312156200251257600080fd5b81516001600160401b038111156200252957600080fd5b8201601f810184136200253b57600080fd5b80516200254c620020098262001fbc565b8181528560208385010111156200256257600080fd5b6200257582602083016020860162001f0a565b95945050505050565b634e487b7160e01b600052603260045260246000fd5b600060208284031215620025a757600080fd5b815162000dbf81620022a0565b634e487b7160e01b600052601160045260246000fd5b600060018201620025df57620025df620025b4565b5060010190565b600081620025f857620025f8620025b4565b506000190190565b8181038181111562001cb35762001cb3620025b4565b828152604060208201526000620020e4604083018462001f30565b8082018082111562001cb35762001cb3620025b4565b6000826200266557634e487b7160e01b600052601260045260246000fd5b50049056fe60c0604052600060a09081526002906200001a9082620000eb565b503480156200002857600080fd5b506000608052600380546001600160a01b03191633179055620001b7565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200007157607f821691505b6020821081036200009257634e487b7160e01b600052602260045260246000fd5b50919050565b601f821115620000e657600081815260208120601f850160051c81016020861015620000c15750805b601f850160051c820191505b81811015620000e257828155600101620000cd565b5050505b505050565b81516001600160401b0381111562000107576200010762000046565b6200011f816200011884546200005c565b8462000098565b602080601f8311600181146200015757600084156200013e5750858301515b600019600386901b1c1916600185901b178555620000e2565b600085815260208120601f198616915b82811015620001885788860151825594840194600190910190840162000167565b5085821015620001a75787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b608051611a29620001d36000396000610b550152611a296000f3fe6080604052600436106200012e5760003560e01c80636a9ef29411620000af578063bd666ab5116200006d578063bd666ab51462000401578063c41a360a1462000418578063ce55f673146200043d578063dd473fae1462000488578063df41c3cf14620004a4576200012e565b80636a9ef29414620003405780638da5cb5b1462000357578063a6f9dae11462000392578063ae52575c14620003b7578063b633620c14620003dc576200012e565b80632b68b9c611620000fd5780632b68b9c6146200029e5780632e489fcb14620002b657806331a4bcb514620002cd57806358edef4c14620002f2578063590e1ae31462000328576200012e565b8063038cd79f146200020b5780630800e30014620002245780630936286114620002615780631c993ad51462000279575b3480156200013b57600080fd5b506000620001db6002805462000151906200126d565b80601f01602080910402602001604051908101604052809291908181526020018280546200017f906200126d565b8015620001d05780601f10620001a457610100808354040283529160200191620001d0565b820191906000526020600020905b815481529060010190602001808311620001b257829003601f168201915b5050505050620004d5565b9050600081604051602001620001f29190620012cf565b6040516020818303038152906040529050805160208201f35b620002226200021c366004620013af565b620004fd565b005b3480156200023157600080fd5b5062000249620002433660046200141a565b62000555565b604051620002589190620012cf565b60405180910390f35b3480156200026e57600080fd5b506200024962000593565b3480156200028657600080fd5b50620002226200029836600462001434565b62000629565b348015620002ab57600080fd5b506200022262000668565b62000222620002c736600462001475565b620006a3565b348015620002da57600080fd5b5062000222620002ec36600462001475565b620006de565b348015620002ff57600080fd5b50620003176200031136600462001434565b6200084b565b604051901515815260200162000258565b3480156200033557600080fd5b50620002226200089d565b6200022262000351366004620014b5565b62000907565b3480156200036457600080fd5b5060035462000379906001600160a01b031681565b6040516001600160a01b03909116815260200162000258565b3480156200039f57600080fd5b5062000222620003b1366004620014e4565b62000958565b348015620003c457600080fd5b5062000249620003d636600462001434565b620004d5565b348015620003e957600080fd5b5062000249620003fb3660046200141a565b62000a06565b620002226200041236600462001502565b62000a29565b3480156200042557600080fd5b5062000379620004373660046200141a565b62000a38565b3480156200044a57600080fd5b50620004796200045c36600462001475565b600160209081526000928352604080842090915290825290205481565b60405190815260200162000258565b3480156200049557600080fd5b50636175746f60e01b62000479565b348015620004b157600080fd5b5062000479620004c33660046200141a565b60006020819052908152604090205481565b60606000620004e5836020015190565b90506000620004f48262000a6a565b50949350505050565b6003546001600160a01b03163314620005335760405162461bcd60e51b81526004016200052a9062001543565b60405180910390fd5b600062000541836020015190565b90506200055081833462000acb565b505050565b60606200058d620005668362000be1565b6040516020016200057891906200156c565b604051602081830303815290604052620004d5565b92915050565b60028054620005a2906200126d565b80601f0160208091040260200160405190810160405280929190818152602001828054620005d0906200126d565b8015620006215780601f10620005f55761010080835404028352916020019162000621565b820191906000526020600020905b8154815290600101906020018083116200060357829003601f168201915b505050505081565b6003546001600160a01b03163314620006565760405162461bcd60e51b81526004016200052a9062001543565b6002620006648282620015e3565b5050565b6003546001600160a01b03163314620006955760405162461bcd60e51b81526004016200052a9062001543565b6003546001600160a01b0316ff5b62000664620006b28362000be1565b604051602001620006c49190620016b0565b6040516020818303038152906040526200021c8362000be9565b6000620006eb8262000be1565b604051602001620006fd9190620016df565b604051602081830303815290604052905060006200071b8362000be1565b6040516020016200072d9190620016b0565b604051602081830303815290604052905060006200074b8462000be1565b6040516020016200075d91906200156c565b6040516020818303038152906040529050838514620008205760006200078384620004d5565b9050620007bc620007948762000be1565b604051602001620007a69190620016df565b60405160208183030381529060405282620004fd565b6000620007c984620004d5565b9050620007ec620007da8862000be1565b604051602001620007a69190620016b0565b6000620007f984620004d5565b90506200081c6200080a8962000be1565b604051602001620007a691906200156c565b5050505b6200082b836200084b565b5062000837826200084b565b5062000843816200084b565b505050505050565b6003546000906001600160a01b031633146200087b5760405162461bcd60e51b81526004016200052a9062001543565b600062000889836020015190565b9050620008968162000d63565b9392505050565b6003546001600160a01b03163314620008ca5760405162461bcd60e51b81526004016200052a9062001543565b6003546040516001600160a01b03909116904780156108fc02916000818181858888f1935050505015801562000904573d6000803e3d6000fd5b50565b62000664620009168362000be1565b604051602001620009289190620016df565b60408051601f198184030181526001600160a01b038516600560a21b1860148401526034830190915290620004fd565b6003546001600160a01b03163314620009aa5760405162461bcd60e51b815260206004820152601360248201527221b0b63632b91034b9903737ba1037bbb732b960691b60448201526064016200052a565b6003546040516001600160a01b038084169216907f342827c97908e5e2f71151c08502a66d44b6f758e3ac2f1de95f02eb95f0a73590600090a3600380546001600160a01b0319166001600160a01b0392909216919091179055565b60606200058d62000a178362000be1565b604051602001620005789190620016b0565b620006646200080a8362000be1565b60008062000a5c62000a4a8462000be1565b604051602001620005789190620016df565b905062000896816014015190565b6000818152602081905260408120546060919062000a888162000e10565b1562000ab457600084815260016020526040812062000aa8908362000e25565b95600195509350505050565b8062000ac08162000ecc565b935093505050915091565b60008381526020819052604090205462000ae58162000e10565b62000b5357806001600160a01b0381161562000b5157806001600160a01b0316632b68b9c66040518163ffffffff1660e01b8152600401600060405180830381600087803b15801562000b3757600080fd5b505af115801562000b4c573d6000803e3d6000fd5b505050505b505b7f000000000000000000000000000000000000000000000000000000000000000060ff168351111562000bb15762000b9c62000b90848462000f86565b6001600160a01b031690565b60008581526020819052604090205562000bdb565b600084815260016020526040902062000bcb908462001065565b6000858152602081905260409020555b50505050565b60606200058d825b60408051606480825260a08201909252606091906000908260208201818036833701905050905060005b841562000c8a57600062000c29600a8762001720565b905062000c38600a876200174d565b955062000c4781603062001764565b60f81b838362000c57816200177a565b94508151811062000c6c5762000c6c62001796565b60200101906001600160f81b031916908160001a9053505062000c13565b600062000c9982600162001764565b67ffffffffffffffff81111562000cb45762000cb462001304565b6040519080825280601f01601f19166020018201604052801562000cdf576020820181803683370190505b50905060005b82811162000d59578362000cfa8285620017ac565b8151811062000d0d5762000d0d62001796565b602001015160f81c60f81b82828151811062000d2d5762000d2d62001796565b60200101906001600160f81b031916908160001a9053508062000d50816200177a565b91505062000ce5565b5095945050505050565b6000818152602081905260408120548062000d815750600092915050565b62000d8c8162000e10565b62000dfa57806001600160a01b0381161562000df857806001600160a01b0316632b68b9c66040518163ffffffff1660e01b8152600401600060405180830381600087803b15801562000dde57600080fd5b505af115801562000df3573d6000803e3d6000fd5b505050505b505b5050600090815260208190526040812055600190565b60008062000e1e8360e01c90565b1192915050565b6060600062000e3483620010ff565b92509050601c81111562000ec557603c82016000805b6020600162000e5b601c87620017ac565b62000e6890602062001764565b62000e749190620017ac565b62000e8091906200174d565b81101562000ec15760008181526020888152604090912054808552925062000eaa90849062001764565b92508062000eb8816200177a565b91505062000e4a565b5050505b5092915050565b6060600080600062000ede856200116b565b915091508062000f035750506040805160008082526020820190925294909350915050565b60008267ffffffffffffffff81111562000f215762000f2162001304565b6040519080825280601f01601f19166020018201604052801562000f4c576020820181803683370190505b50905060006040518061016001604052806101268152602001620018ce6101269139519050838160208401893c5095600195509350505050565b6000806040518061016001604052806101268152602001620018ce6101269139805185519192509060009062000fbd908362001764565b808452601f19603f8201168401604052905062000ff060208701836020860162000fe8919062001764565b8851620011d1565b6000620010006043602062001764565b3085820152905062001015608c602062001764565b9050308185015250600085846040516200102f906200125f565b6200103b9190620012cf565b6040518091039082f090508015801562001059573d6000803e3d6000fd5b50979650505050505050565b805160208083015160e083901b911c1790601c81111562000ec5576000603c8401815b6020600162001099601c87620017ac565b620010a690602062001764565b620010b29190620017ac565b620010be91906200174d565b81101562000ec15781519250620010d782602062001764565b6000828152602089905260409020849055915080620010f6816200177a565b91505062001088565b600060606200110e8360e01c90565b9150602083901b92508167ffffffffffffffff81111562001133576200113362001304565b6040519080825280601f01601f1916602001820160405280156200115e576020820181803683370190505b5060208101939093525091565b6000806001600160a01b0383166200118857506000928392509050565b6000806040518061016001604052806101268152602001620018ce6101269139519050843b915080821015620011c5575060009485945092505050565b62000aa88183620017ac565b620011dd818462001764565b9250620011eb818362001764565b91505b602081106200122e5762001204602083620017ac565b915062001213602084620017ac565b80518352925062001226602082620017ac565b9050620011ee565b806000036200123c57505050565b620012488184620017ac565b9250620012568183620017ac565b92519092525050565b61010b80620017c383390190565b600181811c908216806200128257607f821691505b602082108103620012a357634e487b7160e01b600052602260045260246000fd5b50919050565b60005b83811015620012c6578181015183820152602001620012ac565b50506000910152565b6020815260008251806020840152620012f0816040850160208701620012a9565b601f01601f19169190910160400192915050565b634e487b7160e01b600052604160045260246000fd5b600082601f8301126200132c57600080fd5b813567ffffffffffffffff808211156200134a576200134a62001304565b604051601f8301601f19908116603f0116810190828211818310171562001375576200137562001304565b816040528381528660208588010111156200138f57600080fd5b836020870160208301376000602085830101528094505050505092915050565b60008060408385031215620013c357600080fd5b823567ffffffffffffffff80821115620013dc57600080fd5b620013ea868387016200131a565b935060208501359150808211156200140157600080fd5b5062001410858286016200131a565b9150509250929050565b6000602082840312156200142d57600080fd5b5035919050565b6000602082840312156200144757600080fd5b813567ffffffffffffffff8111156200145f57600080fd5b6200146d848285016200131a565b949350505050565b600080604083850312156200148957600080fd5b50508035926020909101359150565b80356001600160a01b0381168114620014b057600080fd5b919050565b60008060408385031215620014c957600080fd5b82359150620014db6020840162001498565b90509250929050565b600060208284031215620014f757600080fd5b620008968262001498565b600080604083850312156200151657600080fd5b82359150602083013567ffffffffffffffff8111156200153557600080fd5b62001410858286016200131a565b6020808252600f908201526e36bab9ba10333937b69037bbb732b960891b604082015260600190565b6000825162001580818460208701620012a9565b6618dbdb5b595b9d60ca1b920191825250600701919050565b601f8211156200055057600081815260208120601f850160051c81016020861015620015c25750805b601f850160051c820191505b818110156200084357828155600101620015ce565b815167ffffffffffffffff81111562001600576200160062001304565b62001618816200161184546200126d565b8462001599565b602080601f831160018114620016505760008415620016375750858301515b600019600386901b1c1916600185901b17855562000843565b600085815260208120601f198616915b82811015620016815788860151825594840194600190910190840162001660565b5085821015620016a05787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b60008251620016c4818460208701620012a9565b68074696d657374616d760bc1b920191825250600901919050565b60008251620016f3818460208701620012a9565b6437bbb732b960d91b920191825250600501919050565b634e487b7160e01b600052601260045260246000fd5b6000826200173257620017326200170a565b500690565b634e487b7160e01b600052601160045260246000fd5b6000826200175f576200175f6200170a565b500490565b808201808211156200058d576200058d62001737565b6000600182016200178f576200178f62001737565b5060010190565b634e487b7160e01b600052603260045260246000fd5b818103818111156200058d576200058d6200173756fe608060405260405161010b38038061010b83398101604081905261002291610041565b80518060208301f35b634e487b7160e01b600052604160045260246000fd5b6000602080838503121561005457600080fd5b82516001600160401b038082111561006b57600080fd5b818501915085601f83011261007f57600080fd5b8151818111156100915761009161002b565b604051601f8201601f19908116603f011681019083821181831017156100b9576100b961002b565b8160405282815288868487010111156100d157600080fd5b600093505b828410156100f357848401860151818501870152928501926100d6565b60008684830101528096505050505050509291505056fe6080604052348015600f57600080fd5b506004361060325760003560e01c80632b68b9c61460375780638da5cb5b14603f575b600080fd5b603d6081565b005b60657f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b03909116815260200160405180910390f35b336001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161460ed5760405162461bcd60e51b815260206004820152600e60248201526d3737ba10333937b69037bbb732b960911b604482015260640160405180910390fd5b33fffea2646970667358221220fc66c9afb7cb2f6209ae28167cf26c6c06f86a82cbe3c56de99027979389a1be64736f6c63430008070033a26469706673582212200834939d2b8fa0be4bf7fdd9de3190407d6ac48134a2689062bc296487b9ffa464736f6c63430008120033608060405260405161010b38038061010b83398101604081905261002291610041565b80518060208301f35b634e487b7160e01b600052604160045260246000fd5b6000602080838503121561005457600080fd5b82516001600160401b038082111561006b57600080fd5b818501915085601f83011261007f57600080fd5b8151818111156100915761009161002b565b604051601f8201601f19908116603f011681019083821181831017156100b9576100b961002b565b8160405282815288868487010111156100d157600080fd5b600093505b828410156100f357848401860151818501870152928501926100d6565b60008684830101528096505050505050509291505056fe6080604052348015600f57600080fd5b506004361060325760003560e01c80632b68b9c61460375780638da5cb5b14603f575b600080fd5b603d6081565b005b60657f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b03909116815260200160405180910390f35b336001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161460ed5760405162461bcd60e51b815260206004820152600e60248201526d3737ba10333937b69037bbb732b960911b604482015260640160405180910390fd5b33fffea2646970667358221220fc66c9afb7cb2f6209ae28167cf26c6c06f86a82cbe3c56de99027979389a1be64736f6c63430008070033a2646970667358221220a97c983717f7a4ff007b5c88bd81d1d98094e2637db4c4c3beec046fb1a7437464736f6c6343000812003360c0604052600060a09081526003906200001a90826200010e565b503480156200002857600080fd5b5060405162001fe138038062001fe18339810160408190526200004b91620001da565b60ff16608052600280546001600160a01b0319163317905562000206565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200009457607f821691505b602082108103620000b557634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156200010957600081815260208120601f850160051c81016020861015620000e45750805b601f850160051c820191505b818110156200010557828155600101620000f0565b5050505b505050565b81516001600160401b038111156200012a576200012a62000069565b62000142816200013b84546200007f565b84620000bb565b602080601f8311600181146200017a5760008415620001615750858301515b600019600386901b1c1916600185901b17855562000105565b600085815260208120601f198616915b82811015620001ab578886015182559484019460019091019084016200018a565b5085821015620001ca5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b600060208284031215620001ed57600080fd5b815160ff81168114620001ff57600080fd5b9392505050565b608051611db862000229600039600081816104010152610b5a0152611db86000f3fe6080604052600436106200012e5760003560e01c806358edef4c11620000af578063a6f9dae1116200006d578063a6f9dae114620004f9578063caf12836146200051e578063d84eb56c1462000559578063dd473fae146200057e578063f916c5b0146200059c576200012e565b806358edef4c1462000437578063590e1ae3146200045c5780635ba1d9e514620004745780638bf4515c14620004995780638da5cb5b14620004be576200012e565b80631c993ad511620000fd5780631c993ad514620003695780632b68b9c6146200038e57806342216bed14620003a6578063492c7b2a14620003da5780634eed7cf114620003f1576200012e565b8063038cd79f14620002b05780630936286114620002c95780631a7237e014620002f95780631c5ee10c146200032e575b3480156200013b57600080fd5b5060003660608082840362000161575050604080516020810190915260008152620002a5565b838360008181106200017757620001776200153e565b9050013560f81c60f81b6001600160f81b031916602f60f81b14620001c357505060408051808201909152600e81526d0d2dcc6dee4e4cac6e840e0c2e8d60931b6020820152620002a5565b8383620001d26001826200156a565b818110620001e457620001e46200153e565b909101356001600160f81b031916602f60f81b03905062000246576200023d62000212846001818862001580565b60036040516020016200022893929190620015e2565b604051602081830303815290604052620005c1565b50905062000298565b6200029462000259846001818862001580565b8080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250620005c192505050565b5090505b620002a381620005e0565b505b915050805190602001f35b620002c7620002c13660046200175f565b62000621565b005b348015620002d657600080fd5b50620002e162000673565b604051620002f0919062001823565b60405180910390f35b3480156200030657600080fd5b506200031e6200031836600462001838565b62000709565b604051620002f092919062001881565b3480156200033b57600080fd5b50620003536200034d366004620018a7565b6200072c565b60408051928352602083019190915201620002f0565b3480156200037657600080fd5b50620002c762000388366004620018a7565b62000741565b3480156200039b57600080fd5b50620002c762000780565b348015620003b357600080fd5b50620003cb620003c536600462001838565b620007bb565b604051908152602001620002f0565b620002c7620003eb366004620018e8565b620007dd565b348015620003fe57600080fd5b507f000000000000000000000000000000000000000000000000000000000000000060ff1615155b6040519015158152602001620002f0565b3480156200044457600080fd5b50620003cb62000456366004620018a7565b62000826565b3480156200046957600080fd5b50620002c76200086a565b3480156200048157600080fd5b50620004266200049336600462001838565b620008d4565b348015620004a657600080fd5b506200031e620004b8366004620018a7565b620005c1565b348015620004cb57600080fd5b50600254620004e0906001600160a01b031681565b6040516001600160a01b039091168152602001620002f0565b3480156200050657600080fd5b50620002c7620005183660046200195f565b6200091e565b3480156200052b57600080fd5b50620005436200053d36600462001838565b6200096d565b60408051928352901515602083015201620002f0565b3480156200056657600080fd5b50620003cb6200057836600462001838565b62000983565b3480156200058b57600080fd5b50651b585b9d585b60d21b620003cb565b348015620005a957600080fd5b50620003cb620005bb366004620018a7565b620009c6565b60606000620005d78380519060200120620009da565b91509150915091565b600081516040620005f291906200198a565b9050601f19620006048260206200198a565b6200061190601f6200198a565b1690506020808303528060208303f35b6002546001600160a01b03163314620006575760405162461bcd60e51b81526004016200064e90620019a0565b60405180910390fd5b6200066e8380519060200120600084843462000b4a565b505050565b600380546200068290620015ac565b80601f0160208091040260200160405190810160405280929190818152602001828054620006b090620015ac565b8015620007015780601f10620006d55761010080835404028352916020019162000701565b820191906000526020600020905b815481529060010190602001808311620006e357829003601f168201915b505050505081565b606060006200072084805190602001208462000c34565b915091505b9250929050565b600080620005d7838051906020012062000cad565b6002546001600160a01b031633146200076e5760405162461bcd60e51b81526004016200064e90620019a0565b60036200077c828262001a1b565b5050565b6002546001600160a01b03163314620007ad5760405162461bcd60e51b81526004016200064e90620019a0565b6002546001600160a01b0316ff5b600080620007ca848462000709565b5080516020909101209150505b92915050565b6002546001600160a01b031633146200080a5760405162461bcd60e51b81526004016200064e90620019a0565b6200082084805190602001208484843462000b4a565b50505050565b6002546000906001600160a01b03163314620008565760405162461bcd60e51b81526004016200064e90620019a0565b620007d78280519060200120600062000d04565b6002546001600160a01b03163314620008975760405162461bcd60e51b81526004016200064e90620019a0565b6002546040516001600160a01b03909116904780156108fc02916000818181858888f19350505050158015620008d1573d6000803e3d6000fd5b50565b6002546000906001600160a01b03163314620009045760405162461bcd60e51b81526004016200064e90620019a0565b6200091783805190602001208362000dcc565b9392505050565b6002546001600160a01b031633146200094b5760405162461bcd60e51b81526004016200064e90620019a0565b600280546001600160a01b0319166001600160a01b0392909216919091179055565b6000806200072084805190602001208462000ebc565b6002546000906001600160a01b03163314620009b35760405162461bcd60e51b81526004016200064e90620019a0565b6200091783805190602001208362000d04565b6000620007d7828051906020012062000f14565b60606000806000620009ec8562000cad565b915091508060000362000a345760005b6040519080825280601f01601f19166020018201604052801562000a27576020820181803683370190505b5095600095509350505050565b60008267ffffffffffffffff81111562000a525762000a526200166f565b6040519080825280601f01601f19166020018201604052801562000a7d576020820181803683370190505b5090506020810160005b8381101562000b3b576000888152602081815260408083208484529091528120549062000ab48262000f53565b1562000af65762000ac58260e01c90565b60008b8152600160209081526040808320878452909152902090915062000aee90838662000f68565b505062000b15565b8162000b02816200101c565b50915062000b1181866200108e565b5050505b62000b2181856200198a565b93505050808062000b329062001ae8565b91505062000a87565b50909660019650945050505050565b62000b568585620010ed565b60ff7f00000000000000000000000000000000000000000000000000000000000000001682111562000bbd5762000b9f62000b9384848462001205565b6001600160a01b031690565b60008681526020818152604080832088845290915290205562000c2d565b60008581526001602090815260408083208784528252918290208251601f860183900483028101830190935284835262000c149290918690869081908401838280828437600092019190915250620012c192505050565b6000868152602081815260408083208884529091529020555b5050505050565b6000828152602081815260408083208484529091528120546060919062000c5b8162000f53565b1562000c95576000858152600160209081526040808320878452909152812062000c86908362001366565b93506001925062000725915050565b8062000ca18162001402565b93509350505062000725565b6000806000805b60008062000cc3878462000ebc565b915091508062000cd557505062000cfa565b62000ce182856200198a565b93508262000cef8162001ae8565b935050505062000cb4565b9094909350915050565b60005b6000838152602081815260408083208584529091529020548062000d2c575062000dc6565b62000d378162000f53565b62000d98576000819050806001600160a01b0316632b68b9c66040518163ffffffff1660e01b8152600401600060405180830381600087803b15801562000d7d57600080fd5b505af115801562000d92573d6000803e3d6000fd5b50505050505b6000848152602081815260408083208684529091528120558262000dbc8162001ae8565b9350505062000d07565b50919050565b6000828152602081815260408083208484529091528120548062000df5576000915050620007d7565b60008481526020819052604081208162000e118660016200198a565b8152602001908152602001600020541462000e31576000915050620007d7565b62000e3c8162000f53565b62000e9d576000819050806001600160a01b0316632b68b9c66040518163ffffffff1660e01b8152600401600060405180830381600087803b15801562000e8257600080fd5b505af115801562000e97573d6000803e3d6000fd5b50505050505b5050600091825260208281526040808420928452919052812055600190565b60008281526020818152604080832084845290915281205481908062000eea57600080925092505062000725565b62000ef58162000f53565b1562000f0857600062000c868260e01c90565b8062000ca1816200101c565b6000805b6000838152602081815260408083208484529091529020548062000f3d5750620007d7565b8162000f498162001ae8565b9250505062000f18565b60008062000f618360e01c90565b1192915050565b600080600062000f7885620014a9565b808652909350905083601c8411156200100e57601c81016000805b6020600162000fa4601c8a6200156a565b62000fb19060206200198a565b62000fbd91906200156a565b62000fc9919062001b04565b8110156200100a57600081815260208b8152604090912054808552925062000ff39084906200198a565b925080620010018162001ae8565b91505062000f93565b5050505b600192505050935093915050565b6000806001600160a01b0383166200103957506000928392509050565b600080604051806101600160405280610126815260200162001c5d6101269139519050843b91508082101562001076575060009485945092505050565b6200108281836200156a565b95600195509350505050565b6000806000806200109f866200101c565b9150915080620010b85760008093509350505062000725565b6000604051806101600160405280610126815260200162001c5d6101269139519050828187893c509095600195509350505050565b600082815260208181526040808320848452909152902054806200118957811580620011425750600083815260208190526040812081620011306001866200156a565b81526020019081526020016000205414155b620011895760405162461bcd60e51b81526020600482015260166024820152751b5d5cdd081c995c1b1858d9481bdc88185c1c195b9960521b60448201526064016200064e565b620011948162000f53565b6200066e57806001600160a01b038116156200082057806001600160a01b0316632b68b9c66040518163ffffffff1660e01b8152600401600060405180830381600087803b158015620011e657600080fd5b505af1158015620011fb573d6000803e3d6000fd5b5050505050505050565b600080604051806101600160405280610126815260200162001c5d610126913985856040516020016200123b9392919062001b27565b60408051601f19818403018152919052905060006200125d604360206200198a565b3083820152905062001272608c60206200198a565b9050308183015250600083826040516200128c9062001530565b62001298919062001823565b6040518091039082f0905080158015620012b6573d6000803e3d6000fd5b509695505050505050565b805160208083015160e083901b911c1790601c8111156200135f576000603c8401815b60206001620012f5601c876200156a565b620013029060206200198a565b6200130e91906200156a565b6200131a919062001b04565b8110156200135b5781519250620013338260206200198a565b6000828152602089905260409020849055915080620013528162001ae8565b915050620012e4565b5050505b5092915050565b606060006200137583620014c4565b92509050601c8111156200135f57603c82016000805b602060016200139c601c876200156a565b620013a99060206200198a565b620013b591906200156a565b620013c1919062001b04565b8110156200135b57600081815260208881526040909120548085529250620013eb9084906200198a565b925080620013f98162001ae8565b9150506200138b565b6060600080600062001414856200101c565b915091508062001426576000620009fc565b60008267ffffffffffffffff8111156200144457620014446200166f565b6040519080825280601f01601f1916602001820160405280156200146f576020820181803683370190505b5090506000604051806101600160405280610126815260200162001c5d6101269139519050838160208401893c5095600195509350505050565b600080620014b78360e01c90565b9360209390931b92915050565b60006060620014d38360e01c90565b9150602083901b92508167ffffffffffffffff811115620014f857620014f86200166f565b6040519080825280601f01601f19166020018201604052801562001523576020820181803683370190505b5060208101939093525091565b61010b8062001b5283390190565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b81810381811115620007d757620007d762001554565b600080858511156200159157600080fd5b838611156200159f57600080fd5b5050820193919092039150565b600181811c90821680620015c157607f821691505b60208210810362000dc657634e487b7160e01b600052602260045260246000fd5b8284823760008382016000815260008454620015fe81620015ac565b600182811680156200161957600181146200162f5762001660565b60ff198416865282151583028601945062001660565b8860005260208060002060005b8581101562001657578154898201529084019082016200163c565b50505082860194505b50929998505050505050505050565b634e487b7160e01b600052604160045260246000fd5b600082601f8301126200169757600080fd5b813567ffffffffffffffff80821115620016b557620016b56200166f565b604051601f8301601f19908116603f01168101908282118183101715620016e057620016e06200166f565b81604052838152866020858801011115620016fa57600080fd5b836020870160208301376000602085830101528094505050505092915050565b60008083601f8401126200172d57600080fd5b50813567ffffffffffffffff8111156200174657600080fd5b6020830191508360208285010111156200072557600080fd5b6000806000604084860312156200177557600080fd5b833567ffffffffffffffff808211156200178e57600080fd5b6200179c8783880162001685565b94506020860135915080821115620017b357600080fd5b50620017c2868287016200171a565b9497909650939450505050565b60005b83811015620017ec578181015183820152602001620017d2565b50506000910152565b600081518084526200180f816020860160208601620017cf565b601f01601f19169290920160200192915050565b602081526000620009176020830184620017f5565b600080604083850312156200184c57600080fd5b823567ffffffffffffffff8111156200186457600080fd5b620018728582860162001685565b95602094909401359450505050565b604081526000620018966040830185620017f5565b905082151560208301529392505050565b600060208284031215620018ba57600080fd5b813567ffffffffffffffff811115620018d257600080fd5b620018e08482850162001685565b949350505050565b60008060008060608587031215620018ff57600080fd5b843567ffffffffffffffff808211156200191857600080fd5b620019268883890162001685565b95506020870135945060408701359150808211156200194457600080fd5b5062001953878288016200171a565b95989497509550505050565b6000602082840312156200197257600080fd5b81356001600160a01b03811681146200091757600080fd5b80820180821115620007d757620007d762001554565b6020808252600f908201526e36bab9ba10333937b69037bbb732b960891b604082015260600190565b601f8211156200066e57600081815260208120601f850160051c81016020861015620019f25750805b601f850160051c820191505b8181101562001a1357828155600101620019fe565b505050505050565b815167ffffffffffffffff81111562001a385762001a386200166f565b62001a508162001a498454620015ac565b84620019c9565b602080601f83116001811462001a88576000841562001a6f5750858301515b600019600386901b1c1916600185901b17855562001a13565b600085815260208120601f198616915b8281101562001ab95788860151825594840194600190910190840162001a98565b508582101562001ad85787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b60006001820162001afd5762001afd62001554565b5060010190565b60008262001b2257634e487b7160e01b600052601260045260246000fd5b500490565b6000845162001b3b818460208901620017cf565b820183858237600093019283525090939250505056fe608060405260405161010b38038061010b83398101604081905261002291610041565b80518060208301f35b634e487b7160e01b600052604160045260246000fd5b6000602080838503121561005457600080fd5b82516001600160401b038082111561006b57600080fd5b818501915085601f83011261007f57600080fd5b8151818111156100915761009161002b565b604051601f8201601f19908116603f011681019083821181831017156100b9576100b961002b565b8160405282815288868487010111156100d157600080fd5b600093505b828410156100f357848401860151818501870152928501926100d6565b60008684830101528096505050505050509291505056fe6080604052348015600f57600080fd5b506004361060325760003560e01c80632b68b9c61460375780638da5cb5b14603f575b600080fd5b603d6081565b005b60657f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b03909116815260200160405180910390f35b336001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161460ed5760405162461bcd60e51b815260206004820152600e60248201526d3737ba10333937b69037bbb732b960911b604482015260640160405180910390fd5b33fffea2646970667358221220fc66c9afb7cb2f6209ae28167cf26c6c06f86a82cbe3c56de99027979389a1be64736f6c63430008070033a2646970667358221220710373a14ab30c4f2903d68937311eebfae19ca610e4d3ac0225c1cbe823b10b64736f6c63430008120033",
          })
      );
      if (receipt) {
        this.deployedBlog = receipt.contractAddress;
        this.inputBlogAddressToLink = this.deployedBlog;
      }
    },
    async onLink() {
      if (!this.domain || !this.inputBlogAddressToLink) {
        return;
      }
      const domainNode = namehash.hash(`${this.domain}.w3q`);
      const contract = nameServiceContract();
      await this._doTx(() =>
          contract.setText(domainNode, "blog", this.inputBlogAddressToLink)
      );
      this.$router.push(`/blog/${this.domain}.w3q`);
    },
    async write() {
      if (!this.markdownEditor) {
        console.warn("editor not ready");
        return;
      }

      const content = this.markdownEditor.value();
      const fileSize = Buffer.byteLength(content, "utf-8");

      const contract = blogContract(this.blogAddress);
      let action,
          reloadCurrentBlog = false;
      if (!this.$route.params.id) {
        let cost = 0;
        if (fileSize > 24 * 1024 - 326) {
          cost = Math.floor((fileSize + 326) / 1024 / 24);
        }
        const balance = await contract.provider.getBalance(this.currentAccount);
        if(balance.lte(ethers.utils.parseEther(cost.toString()))){
          // not enough balance
          this.$notify.error({
            title: 'Not enough balance!',
            message: 'File >=24kb requires staking token.'
          });
          return;
        }

        action = () => contract.writeBlog(
            stringToHex(this.editingTitle),
            stringToHex(content),
            {value: ethers.utils.parseEther(cost.toString())}
        );
      } else {
        const idx = parseInt(this.$route.params.id, 10);
        action = () => contract.editBlog(
            idx,
            stringToHex(this.editingTitle),
            stringToHex(content)
        );
        reloadCurrentBlog = true;
      }
      await this._doTx(action);

      if (reloadCurrentBlog) {
        this.$asyncComputed.currentBlog.update();
      } else {
        this.$asyncComputed.blogs.update();
      }
    },
    async deleteBlog() {
      const idx = parseInt(this.$route.params.id, 10);
      const contract = blogContract(this.blogAddress);
      await this._doTx(() => contract.deleteBlog(idx));
      this.$router.push(`/blog/${this.blogAddress}`);
      this.$asyncComputed.blogs.update();
    },
    async onComment() {
      if (!this.commentText || !this.blogAddress || !this.$route.params.id) {
        console.warn("comment not ready");
        return;
      }

      const content = this.commentText.toString();
      const contract = blogContract(this.blogAddress);
      const idx = parseInt(this.$route.params.id, 10);
      let action = () => contract.writeComment(idx, stringToHex(content));

      await this._doTx(action);
      this.$asyncComputed.comments.update();
      this.commentText = "";
    },
    openCreateModal() {
      this.editingTitle = "";
      this.isEditingBlog = true;
    },
    openEditModal() {
      this.editingTitle = this.currentBlog.title;
      this.isEditingBlog = true;
    },
    initSimpleMDE() {
      if (!this.markdownEditor) {
        this.markdownEditor = new SimpleMDE({
          element: document.getElementById("markdown-editor"),
        });
      }
      this.markdownEditor.value(this.currentBlog.content || "");
    },
    parseMarkdown(content) {
      if (!content) {
        return "";
      }
      return marked.parse(content);
    },
    async enterBlog() {
      const input = this.inputBlogAddress;
      if (input.startsWith("0x") && input.length === 42) {
        const address = ethers.utils.getAddress(input.toLowerCase());
        this.$router.push(`/blog/${address}`);
        return;
      }
      if (input.endsWith(".w3q")) {
        const domainNode = namehash.hash(input);
        const response = await nameServiceAPI("->(string)")
            .text(`bytes32!${domainNode}`)("string!blog")
            .get();
        let [address] = await response.json();
        if (!address) {
          alert("invalid domain name");
          return;
        }
        address = ethers.utils.getAddress(address.toLowerCase());
        this.$router.push(`/blog/${input}`);
        return;
      }
      alert("invalid address");
    },
    async _doTx(txFunc) {
      try {
        const tx = await txFunc();
        this.isEditingBlog = false;
        this.isLoading = true;
        return await tx.wait();
      } catch (error) {
        alert(
            (error.data && error.data.message) ||
            error.message ||
            "failed to interact with contract"
        );
      } finally {
        this.isLoading = false;
      }
    },
    _renderTimestamp(ts) {
      if (!ts) {
        return "";
      }
      return ts.toLocaleDateString(undefined, {
        day: "numeric",
        month: "short",
        year: "numeric",
      });
    },

    // update
    async uploadFile() {
      if (!this.file || !this.fileAddress) {
        return;
      }

      const readFile = (file) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (res) => {
            const buff = res.target.result;
            resolve(Buffer.from(buff));
          };
          reader.readAsArrayBuffer(file);
        });
      }

      const bufferChunk = (buffer, chunkSize) => {
        let i = 0;
        let result = [];
        const len = buffer.length;
        const chunkLength = Math.ceil(len / chunkSize);
        while (i < len) {
          result.push(buffer.slice(i, i += chunkLength));
        }
        return result;
      }

      this.isLoading = true;
      const fileName = "image/" + this.file.name;
      const hexName = stringToHex(fileName);
      const content = await readFile(this.file);

      // Data need to be sliced if file > 475K
      let fileSize = this.file.size;
      let chunks = [];
      if (fileSize > 475 * 1024) {
        const chunkSize = Math.ceil(fileSize / (475 * 1024));
        chunks = bufferChunk(content, chunkSize);
        fileSize = fileSize / chunkSize;
        this.fileUrl = "The file is too big and exceeds the 475kb limit, so it needs to be uploaded in " + chunks.length + " steps."
      } else {
        chunks.push(content);
      }

      const fileContract = FileContract(this.fileAddress);
      let uploadState = true;
      let notEnoughBalance = false;
      for (const index in chunks) {
        const chunk = chunks[index];

        let cost = 0;
        if (fileSize > 24 * 1024 - 326) {
          cost = Math.floor((fileSize + 326) / 1024 / 24);
        }

        const hexData = '0x' + chunk.toString('hex');
        const localHash = '0x' + sha3(chunk);
        const hash = await fileContract.getChunkHash(hexName, index);
        if (localHash === hash) {
          console.log(`File ${fileName} chunkId: ${index}: The data is not changed.`);
          continue;
        }

        try {
          const balance = await fileContract.provider.getBalance(this.currentAccount);
          if(balance.lte(ethers.utils.parseEther(cost.toString()))){
            // not enough balance
            uploadState = false;
            notEnoughBalance = true;
            break;
          }

          // file is remove or change
          const tx = await fileContract.writeChunk(hexName, index, hexData, {
            value: ethers.utils.parseEther(cost.toString())
          });
          console.log(`Transaction Id: ${tx.hash}`);
          this.fileUrl = "Uploaded steps:" + index + "/" + chunks.length;
          const receipt = await tx.wait();
          if (!receipt.status) {
            uploadState = false;
            break;
          }
          const temp = Number(index) + 1;
          this.fileUrl = "Uploaded steps:" + temp + "/" + chunks.length;
        } catch (e) {
          uploadState = false;
          break;
        }
      }

      if (uploadState) {
        this.fileUrl = "https://galileo.web3q.io/" + this.fileAddress + ":3334/" + fileName;
      } else {
        if (notEnoughBalance) {
          this.$notify.error({
            title: 'Not enough balance!',
            message: 'File >=24kb requires staking token.'
          });
        }
        this.fileUrl = `${fileName} upload fail!`;
      }
      this.isLoading = false;
    },
  },
  computed: {
    mode() {
      if (!this.$route.params.address) {
        return "init";
      }
      if (!this.$route.params.id) {
        return "list";
      }
      return "content";
    },
    isChainSupported() {
      return this.currentAccount !== null;
    },
    isOwner() {
      if (!this.currentAccount || !this.$asyncComputed.owner.success) {
        return false;
      }
      return this.currentAccount.toUpperCase() == this.owner.toUpperCase();
    },
    deployBlogMessage() {
      return (
          (this.deployedBlog && `Blog deployed at ${this.deployedBlog}`) || ""
      );
    },
    connectWalletMessage() {
      if (!this.currentAccount) {
        return "Connect Wallet";
      }
      const addr = ethers.utils.getAddress(this.currentAccount);
      return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
    },
  },
  asyncComputed: {
    async chainId() {
      const currentChainId = await window.ethereum.request({
        method: "eth_chainId",
      });
      return parseInt(currentChainId, 16);
    },
    blogAddress: {
      async get() {
        const address = this.$route.params.address;
        if (!address) {
          return "";
        }
        if (address.startsWith("0x") && address.length === 42) {
          return ethers.utils.getAddress(address.toLowerCase());
        }
        if (address.endsWith(".w3q")) {
          const domainNode = namehash.hash(address);
          const response = await nameServiceAPI("->(string)")
              .text(`bytes32!${domainNode}`)("string!blog")
              .get();
          const [realAddress] = await response.json();
          if (!realAddress) {
            alert("invalid domain name");
            return "";
          }
          return ethers.utils.getAddress(realAddress.toLowerCase());
        }
        alert("invalid blog address");
        return "";
      },
    },
    blogs: {
      async get() {
        if (this.mode !== "list" || !this.blogAddress) {
          return [];
        }
        const addr = this.blogAddress;
        const blogs = [];
        try {
          const response = await blogAPI(
              `${addr}:3334->(bytes[],uint256[],uint256[])`
          ).listBlogs.get();
          if (response.status == 400) {
            throw new Error("invalid blog contract address");
          } else if (response.status > 400 && response.status < 600) {
            throw new Error("gateway error");
          }
          const [titles, timestamps, idxList] = await response.json();
          for (let i = 0; i < titles.length; i++) {
            blogs.push({
              title: hexToString(titles[i]) || "<empty>",
              timestamp: new Date(parseInt(timestamps[i], 10) * 1000),
              idx: parseInt(idxList[i], 10),
            });
          }
        } catch (err) {
          console.error(err);
          const ret = [];
          ret.message = `<${
              (err.message && err.message.toLowerCase()) || "unknown error"
          }>`;
          return ret;
        }
        return blogs;
      },
      default: [],
      watch: ["$route.params.id"],
    },
    currentBlog: {
      async get() {
        if (this.mode !== "content" || !this.blogAddress) {
          return {};
        }

        const addr = this.blogAddress;
        try {
          const response = await blogAPI(`${addr}:3334->(bytes,uint256,bytes)`)
              .getBlog(this.$route.params.id)
              .get();
          if (response.status >= 400 && response.status < 600) {
            throw new Error("gateway error");
          }
          const [title, timestampStr, content] = await response.json();
          const timestamp = parseInt(timestampStr, 10);
          if (timestamp === 0) {
            return {
              title: "<post deleted>",
              content: "",
            };
          }
          return {
            title: hexToString(title),
            timestamp: new Date(timestamp * 1000),
            content: hexToString(content),
          };
        } catch (e) {
          console.warn(e);
          return {
            title: "<post not found>",
            content: "",
          };
        }
      },
      default: {title: "", timestamp: null, content: ""},
      watch: ["$route.params.id"],
    },
    async prevPost() {
      if (this.mode !== "content" || !this.blogAddress) {
        return null;
      }
      const response = await blogAPI(`${this.blogAddress}:3334->(uint256,bool)`)
          .prevPost(this.$route.params.id)
          .get();
      const [prevIdx, exists] = await response.json();
      if (!exists) {
        return null;
      }
      return `/blog/${this.$route.params.address}/${prevIdx}`;
    },
    async nextPost() {
      if (this.mode !== "content" || !this.blogAddress) {
        return null;
      }
      const response = await blogAPI(`${this.blogAddress}:3334->(uint256,bool)`)
          .nextPost(this.$route.params.id)
          .get();
      const [nextIdx, exists] = await response.json();
      if (!exists) {
        return null;
      }
      return `/blog/${this.$route.params.address}/${nextIdx}`;
    },
    async owner() {
      if (!this.blogAddress) {
        return "";
      }
      const response = await blogAPI(
          `${this.blogAddress}:3334->(address)`
      ).owner.get();
      const [owner] = await response.json();
      return owner;
    },
    comments: {
      async get() {
        if (this.mode !== "content" || !this.blogAddress || !this.$route.params.id) {
          return [];
        }

        const addr = this.blogAddress;
        const comments = [];
        try {
          const response = await blogAPI(
              `${addr}:3334->(address[],bytes[],bytes[])`
          ).getComments(this.$route.params.id).get();
          if (response.status === 400) {
            throw new Error("invalid comment contract address");
          } else if (response.status > 400 && response.status < 600) {
            throw new Error("gateway error");
          }

          const [users, timestamps, contents] = await response.json();
          for (let i = 0; i < timestamps.length; i++) {
            let time = hexToString(timestamps[i]).trim();
            time = time.replace("\u0000", "");
            comments.push({
              content: hexToString(contents[i]) || "<empty>",
              timestamp: Number(time) * 1000,
              user: users[i]
            });
          }
          comments.sort(function (a, b) {
            return a.timestamp - b.timestamp
          });
        } catch (err) {
          console.error(err);
          return [];
        }
        return comments;
      },
      default: [],
      watch: ["$route.params.id"],
    },
    fileAddress: {
      async get() {
        const address = this.blogAddress;
        if (!address) {
          return "";
        }
        const response = await blogAPI(`${address}:3334->(address)`)
            .assets()
            .get();
        const [realAddress] = await response.json();
        console.log(realAddress);
        if (!realAddress) {
          return "";
        }
        return ethers.utils.getAddress(realAddress.toLowerCase());
      },
      default: "",
      watch() {
        this.blogAddress
      }
    }
  },
  watch: {
    file: function () {
      this.uploadFile();
    }
  }
};
</script>

<style>
.showcase-box {
  text-align: left;
  font-family: "Segoe UI", Helvetica, Arial, sans-serif;
  font-weight: normal;
}

.code input {
  font-family: Courier, monospace;
}

.connect-wallet {
  position: absolute;
  right: 0px;
}

.blog {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 24px;
  font-weight: 600;
  line-height: 1.42857143;
  text-align: left;
}

.blog p,
.blog li {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue",
  Helvetica, Roboto, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
  "Segoe UI Symbol";
  font-weight: normal;
  font-size: 18px;
  line-height: 1.5;
  word-wrap: break-word;
}

.content {
  font-size: 100%;
}

.blog-time {
  font-size: 14px;
  color: #828282;
}

p.title {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue",
  Helvetica, Roboto, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
  "Segoe UI Symbol";
}

p.subtitle {
  font-size: 85%;
  color: #888;
}

.markdown-editor-wrapper {
  text-align: left;
  font-weight: normal;
  font-family: BlinkMacSystemFont, -apple-system, "Segoe UI", "Roboto", "Oxygen",
  "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue",
  "Helvetica", "Arial", sans-serif;
}

.CodeMirror,
.CodeMirror-scroll {
  min-height: 200px;
  max-height: 600px;
}

.editor-preview,
.editor-preview-side {
  font-size: 100%;
}

.editor-preview ul,
.editor-preview-side ul {
  padding: revert;
  list-style: disc;
}

/* Revert some universal CSS */
.markdown-editor-wrapper h1,
.markdown-editor-wrapper h2,
.markdown-editor-wrapper h3,
.markdown-editor-wrapper h4,
.markdown-editor-wrapper h5,
.markdown-editor-wrapper h6 {
  font-size: revert;
  font-weight: revert;
}

.footer-layout {
  margin-top: 140px;
}
</style>
